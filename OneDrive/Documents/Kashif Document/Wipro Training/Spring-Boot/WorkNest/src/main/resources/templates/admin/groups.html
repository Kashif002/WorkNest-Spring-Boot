<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <div th:replace="fragments/header :: head"></div>
    <title>Manage Groups</title>
    <style>
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .btn { padding: 10px 20px; border-radius: 5px; text-decoration: none; color: white; font-weight: 500; cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        .action-buttons { display: flex; gap: 0.5rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .content-box { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: var(--shadow); }
        .table { width: 100%; border-collapse: collapse; margin-top: 1.5rem;}
        .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .form-group { margin-bottom: 1rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .multi-select { height: 150px; }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>
    
    <script>
        // Check authentication on page load
        function checkAuth() {
            const token = sessionStorage.getItem('jwtToken');
            const userRole = sessionStorage.getItem('userRole');
            
            if (!token || userRole !== 'ADMIN') {
                window.location.href = '/login';
                return;
            }
            
            // Check if token is expired
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const expirationTime = payload.exp * 1000;
                const currentTime = Date.now();
                
                if (currentTime >= expirationTime) {
                    sessionStorage.clear();
                    document.cookie = 'jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                    window.location.href = '/login';
                }
            } catch (error) {
                sessionStorage.clear();
                window.location.href = '/login';
            }
        }
        
        checkAuth();
    </script>
    <main class="container">
        <div class="page-header">
             <h1>Manage Groups</h1>
        </div>
        
        <!-- Flash Messages -->
        <div th:if="${success}" style="background-color: #d4edda; color: #155724; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
            <span th:text="${success}"></span>
        </div>
        <div th:if="${error}" style="background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
            <span th:text="${error}"></span>
        </div>
        <div class="content-box">
             <h2>Create New Group</h2>
             <form th:action="@{/admin/groups/add}" th:object="${group}" method="post">
                <div class="form-group">
                    <label>Group Name</label>
                    <input type="text" th:field="*{name}" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Add Members</label>
                    <select name="memberIds" class="form-control multi-select" multiple>
                        <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.name}"></option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Save Group</button>
             </form>
        </div>

        <div class="content-box" style="margin-top: 2rem;">
            <h2>Existing Groups</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Members</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="group : ${groups}">
                        <td th:text="${group.name}"></td>
                        <td>
                            <span th:each="member, iterStat : ${group.members}" th:text="${member.name} + (${!iterStat.last} ? ', ' : '')"></span>
                        </td>
                        <td class="action-buttons">
                            <button class="btn btn-small btn-primary" onclick="handleEditGroup(this)" th:attr="data-group-id=${group.id},data-group-name=${group.name}">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="handleDeleteGroup(this)" th:attr="data-group-id=${group.id}">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Edit Group Modal -->
    <div id="editGroupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditGroupModal()">&times;</span>
            <h2>Edit Group</h2>
            <form id="editGroupForm">
                <input type="hidden" id="editGroupId">
                <div class="form-group">
                    <label>Group Name</label>
                    <input type="text" id="editGroupName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Members</label>
                    <select id="editGroupMembers" class="form-control multi-select" multiple>
                        <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.name}"></option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Update Group</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditGroupModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Group management functions
        function handleEditGroup(btn) {
            const groupId = btn.getAttribute('data-group-id');
            const groupName = btn.getAttribute('data-group-name');
            editGroup(groupId, groupName);
        }

        function editGroup(groupId, groupName) {
            document.getElementById('editGroupId').value = groupId;
            document.getElementById('editGroupName').value = groupName;
            
            // Load current group members
            const token = sessionStorage.getItem('jwtToken');
            fetch(`/api/admin/groups/${groupId}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(group => {
                const memberSelect = document.getElementById('editGroupMembers');
                // Clear all selections first
                Array.from(memberSelect.options).forEach(option => option.selected = false);
                // Select current members
                group.members.forEach(member => {
                    const option = memberSelect.querySelector(`option[value="${member.id}"]`);
                    if (option) option.selected = true;
                });
                
                document.getElementById('editGroupModal').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading group:', error);
                alert('Failed to load group details');
            });
        }

        function closeEditGroupModal() {
            document.getElementById('editGroupModal').style.display = 'none';
        }

        function handleDeleteGroup(btn) {
            const groupId = btn.getAttribute('data-group-id');
            deleteGroup(groupId);
        }

        function deleteGroup(groupId) {
            if (confirm('Are you sure you want to delete this group?')) {
                const token = sessionStorage.getItem('jwtToken');
                
                fetch(`/api/admin/groups/${groupId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Group deleted successfully');
                        location.reload();
                    } else {
                        alert('Failed to delete group');
                    }
                })
                .catch(error => {
                    console.error('Error deleting group:', error);
                    alert('Failed to delete group');
                });
            }
        }

        // Handle edit group form submission
        document.getElementById('editGroupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const token = sessionStorage.getItem('jwtToken');
            const groupId = document.getElementById('editGroupId').value;
            const groupName = document.getElementById('editGroupName').value;
            const selectedMembers = Array.from(document.getElementById('editGroupMembers').selectedOptions).map(option => option.value);
            
            const groupData = {
                name: groupName,
                memberIds: selectedMembers
            };

            fetch(`/api/admin/groups/${groupId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(groupData)
            })
            .then(response => {
                if (response.ok) {
                    alert('Group updated successfully');
                    closeEditGroupModal();
                    location.reload();
                } else {
                    alert('Failed to update group');
                }
            })
            .catch(error => {
                console.error('Error updating group:', error);
                alert('Failed to update group');
            });
        });

        // Modal close functionality
        window.onclick = function(event) {
            const modal = document.getElementById('editGroupModal');
            if (event.target == modal) {
                closeEditGroupModal();
            }
        }
    </script>

    <div th:replace="fragments/footer :: footer"></div>
</body>
</html>
