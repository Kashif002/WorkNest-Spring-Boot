<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <div th:replace="fragments/header :: head"></div>
    <title>Manage Tasks</title>
    <style>
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .btn { padding: 10px 20px; border-radius: 5px; text-decoration: none; color: white; font-weight: 500; cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        .btn-success { background-color: #28a745; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        .content-box { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: var(--shadow); }
        .table { width: 100%; border-collapse: collapse; margin-top: 1.5rem;}
        .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .table thead th { background-color: var(--light-gray); font-weight: bold; }
        .form-group { margin-bottom: 1rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .multi-select { height: 150px; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
        .status-PENDING { background-color: #ffc107; color: #333; }
        .status-IN_PROGRESS { background-color: #17a2b8; color: #fff; }
        .status-COMPLETED { background-color: #28a745; color: #fff; }
        .status-DELAYED { background-color: #dc3545; color: #fff; }
        .action-buttons { display: flex; gap: 0.5rem; }
        .completed-by-admin { border-left: 3px solid #28a745; background-color: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>
    
    <script>
        // Check authentication on page load
        function checkAuth() {
            const token = sessionStorage.getItem('jwtToken');
            const userRole = sessionStorage.getItem('userRole');
            
            if (!token || userRole !== 'ADMIN') {
                window.location.href = '/login';
                return;
            }
            
            // Check if token is expired
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const expirationTime = payload.exp * 1000;
                const currentTime = Date.now();
                
                if (currentTime >= expirationTime) {
                    sessionStorage.clear();
                    document.cookie = 'jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                    window.location.href = '/login';
                }
            } catch (error) {
                sessionStorage.clear();
                window.location.href = '/login';
            }
        }
        
        checkAuth();

        // Group and User selection logic
        document.addEventListener('DOMContentLoaded', function() {
            const userSelect = document.getElementById('userSelect');
            const groupSelect = document.getElementById('groupSelect');
            
            // Store group member mappings
            const groupMembers = {};
            
            // Initialize group member mappings from the page data
            <th:block th:each="group : ${groups}">
                groupMembers[<span th:text="${group.id}"></span>] = [
                    <th:block th:each="member, iterStat : ${group.members}">
                        <span th:text="${member.id}"></span><span th:if="${!iterStat.last}">,</span>
                    </th:block>
                ];
            </th:block>
            
            // Handle group selection
            groupSelect.addEventListener('change', function() {
                const selectedGroups = Array.from(this.selectedOptions).map(option => option.value);
                const selectedUsers = new Set();
                
                // Collect all users from selected groups
                selectedGroups.forEach(groupId => {
                    if (groupMembers[groupId]) {
                        groupMembers[groupId].forEach(userId => {
                            selectedUsers.add(userId.toString());
                        });
                    }
                });
                
                // Update user selection
                Array.from(userSelect.options).forEach(option => {
                    if (selectedUsers.has(option.value)) {
                        option.selected = true;
                    }
                });
            });
            
            // Handle user selection (optional: could clear group selection if users are manually selected)
            userSelect.addEventListener('change', function() {
                // This could be used to clear group selection if needed
                // For now, we'll allow both to be selected independently
            });
        });
    </script>

    <main class="container">
        <div class="page-header">
            <h1>Manage Tasks</h1>
            <!-- Add a button to toggle form visibility -->
        </div>
        
        <!-- Flash Messages -->
        <div th:if="${success}" style="background-color: #d4edda; color: #155724; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
            <span th:text="${success}"></span>
        </div>
        <div th:if="${error}" style="background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
            <span th:text="${error}"></span>
        </div>

        <div class="content-box">
            <h2>Add New Task</h2>
            <form th:action="@{/admin/tasks/add}" th:object="${task}" method="post">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" th:field="*{title}" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea th:field="*{description}" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select th:field="*{status}" class="form-control">
                        <option value="PENDING">Pending</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="DELAYED">Delayed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" th:field="*{startDate}" class="form-control" required>
                </div>
                 <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" th:field="*{dueDate}" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Assign to Users</label>
                    <select name="userIds" id="userSelect" class="form-control multi-select" multiple>
                        <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.name + ' (' + user.email + ')'}"></option>
                    </select>
                    <small style="color: #666;">Hold Ctrl/Cmd to select multiple users</small>
                </div>
                <div class="form-group">
                    <label>Or Assign to Groups</label>
                    <select name="groupIds" id="groupSelect" class="form-control multi-select" multiple>
                        <option th:each="group : ${groups}" th:value="${group.id}" th:text="${group.name + ' (' + #lists.size(group.members) + ' members)'}"></option>
                    </select>
                    <small style="color: #666;">Hold Ctrl/Cmd to select multiple groups. All members of selected groups will be assigned to this task.</small>
                </div>
                <button type="submit" class="btn btn-primary">Save Task</button>
            </form>
        </div>

        <div class="content-box" style="margin-top: 2rem;">
            <h2>All Tasks</h2>
            <div id="tasksContainer">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                                            <th>Status</th>
                <th>Due Date</th>
                <th>Assigned To</th>
                <!-- <th>Completed by Admin</th> -->
                <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="task : ${tasks}" th:classappend="${task.completedByAdmin != null and task.completedByAdmin} ? 'completed-by-admin' : ''">
                            <td th:text="${task.id}"></td>
                            <td th:text="${task.title}"></td>
                            <td><span class="status-badge" th:classappend="'status-' + ${task.status}" th:text="${task.status}">PENDING</span></td>
                            <td th:text="${task.dueDate != null ? #dates.format(task.dueDate, 'dd-MMM-yyyy') : 'Not set'}"></td>
                            <td>
                                <span th:if="${task.assignedUsers != null and !#lists.isEmpty(task.assignedUsers)}" 
                                      th:each="user, iterStat : ${task.assignedUsers}" 
                                      th:text="${user.name} + (${!iterStat.last} ? ', ' : '')"></span>
                                <span th:if="${task.assignedUsers == null or #lists.isEmpty(task.assignedUsers)}" 
                                                                              style="color: #999; font-style: italic;">No users assigned</span>
                            </td>
                            <!-- <td>
                                <span th:if="${task.completedByAdmin != null and task.completedByAdmin}" class="status-badge status-COMPLETED">Yes</span>
                                <span th:unless="${task.completedByAdmin != null and task.completedByAdmin}">No</span>
                            </td> -->
                            <td class="action-buttons">
                                <button class="btn btn-small btn-secondary" th:onclick="'reassignTask(' + ${task.id} + ')'">Reassign</button>
                                <button class="btn btn-small btn-success" th:onclick="'markCompleted(' + ${task.id} + ')'">Complete</button>
                                <button class="btn btn-small" style="background-color:#17a2b8; color:#fff;" th:onclick="'viewComments(' + ${task.id} + ')'">View Comments</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- View Comments Modal -->
    <div id="commentsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Task Comments</h2>
            <div id="commentsContainer">
                <p>Loading comments...</p>
            </div>
        </div>
    </div>

    <!-- Reassign Task Modal -->
    <div id="reassignModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Reassign Task</h2>
            <form id="reassignForm">
                <input type="hidden" id="reassignTaskId">
                <div class="form-group">
                    <label>Assign to Users:</label>
                    <select id="reassignUsers" class="form-control multi-select" multiple>
                        <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.name}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Or Assign to Groups:</label>
                    <select id="reassignGroups" class="form-control multi-select" multiple>
                        <option th:each="group : ${groups}" th:value="${group.id}" th:text="${group.name + ' (' + #lists.size(group.members) + ' members)'}"></option>
                    </select>
                    <small style="color: #666;">All members of selected groups will be assigned to this task.</small>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Reassign</button>
                    <button type="button" class="btn btn-secondary" onclick="closeReassignModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Task management functions
        function reassignTask(id) {
            document.getElementById('reassignTaskId').value = id;
            document.getElementById('reassignModal').style.display = 'block';
        }

        function closeReassignModal() {
            document.getElementById('reassignModal').style.display = 'none';
        }

        function markCompleted(id) {
            if (confirm('Are you sure you want to mark this task as completed? Users will not be able to change the status after this.')) {
                const token = sessionStorage.getItem('jwtToken');
                
                fetch(`/api/admin/tasks/${id}/status?status=COMPLETED`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(message => {
                    alert(message);
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update task status: ' + error.message);
                });
            }
        }

        function viewComments(taskId) {
            const token = sessionStorage.getItem('jwtToken');
            document.getElementById('commentsContainer').innerHTML = '<p>Loading comments...</p>';
            document.getElementById('commentsModal').style.display = 'block';

            fetch(`/api/admin/tasks/${taskId}/comments`, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(list => {
                if (!Array.isArray(list) || list.length === 0) {
                    document.getElementById('commentsContainer').innerHTML = '<p>No comments yet.</p>';
                    return;
                }
                const html = '<ul style="list-style:none; padding:0;">' + list.map(c => `
                    <li style="border-bottom:1px solid #eee; padding:0.5rem 0;">
                        <div style="font-weight:600;">${c.user ? c.user.name : 'Unknown'} <span style="font-weight:400; color:#666;">(${new Date(c.createdAt).toLocaleString()})</span></div>
                        <div>${c.content}</div>
                    </li>
                `).join('') + '</ul>';
                document.getElementById('commentsContainer').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading comments:', error);
                document.getElementById('commentsContainer').innerHTML = '<p>Failed to load comments: ' + error.message + '</p>';
            });
        }

        function closeCommentsModal() {
            document.getElementById('commentsModal').style.display = 'none';
        }

        // Handle reassign form submission
        document.getElementById('reassignForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const token = sessionStorage.getItem('jwtToken');
            const taskId = document.getElementById('reassignTaskId').value;
            const selectedUsers = Array.from(document.getElementById('reassignUsers').selectedOptions).map(option => option.value);
            const selectedGroups = Array.from(document.getElementById('reassignGroups').selectedOptions).map(option => option.value);
            
            if (selectedUsers.length === 0 && selectedGroups.length === 0) {
                alert('Please select at least one user or group to reassign.');
                return;
            }

            const formData = new FormData();
            selectedUsers.forEach(userId => formData.append('userIds', userId));
            selectedGroups.forEach(groupId => formData.append('groupIds', groupId));

            fetch(`/api/admin/tasks/${taskId}/reassign?` + new URLSearchParams(formData), {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(message => {
                alert(message);
                closeReassignModal();
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to reassign task: ' + error.message);
            });
        });

        // Modal close functionality
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.close').forEach(function(closeBtn) {
                closeBtn.onclick = function() {
                    // Close the modal that contains this close button
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            });
        });

        window.onclick = function(event) {
            // Close any modal when clicking outside
            const modals = document.querySelectorAll('.modal');
            modals.forEach(function(modal) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>

    <div th:replace="fragments/footer :: footer"></div>
</body>
</html>
